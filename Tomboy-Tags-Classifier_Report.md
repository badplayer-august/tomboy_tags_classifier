# Tomboy Tags classifier

## Introduction

### 動機
在現今網路發達的時代，大量的影像、圖片、畫作在網路上流動，但我們卻難以去依照喜歡的作品風格或是內容去做延伸的搜尋，雖然很多網站提供標籤搜尋，但大部分都是人為去做標示的，非常耗費心力，雖然有出現使用機器學習標示標籤的應用，但這些應用多對於的是實體的描述（例如：髮色，外觀等等），卻較少是標示個性這些偏向抽象的主題（例如：陽光，陰柔等等）。

### 題目
我挑選的主題是判斷圖片中角色個性的問題，因為我認為個性類型的不同角色，在繪畫的呈現中很常會使用體態或治裝去做襯托或詮釋，像是喜愛運動的角色許多時候會強調肌肉線條或是擁有較深的膚色，因此我想看看機器能不能去依照圖片擁有的描述標籤去判斷圖片中人物各自對應個性的屬性。

而其中我選定的屬性依照性別與個性分為以下四種：
![](https://i.imgur.com/Lc3MFF5.png)



## Data Collection

### 挑選網站
我所知可以拿到大量有標示標籤的網站如下：

- pixiv
    - 圖片最多但品質參差不齊
    - 作者標示標籤
    - 標籤種類多但每張圖的標籤量極少
    - 標籤品質普
- danbooru
    - 圖片少但品質不錯
    - 使用者標示標籤
    - 標籤種類多
    - 標籤品質不錯
- rule34
    - 圖片多但品質參差不齊
    - 使用者標示標籤
    - 標籤種類多
    - 標籤品質差
- sankaku complex
    - 圖片多且品質不錯
    - 使用者標示標籤
    - 標籤種類多且每張圖的標籤量多且詳細
    - 標籤品質不錯

pixiv 因為每張照片的標籤量極少所以我並沒做選擇，而在標籤品質、圖片數量、網站架構下，我最後選擇 sankaku complex 作為爬蟲的目標網站。

### 網站特性
網站本身有流量限制，雖然不需要登入就可以使用，但會出現許多需登入才能瀏覽的圖片，且同時搜尋標籤的數量會減少，且會有些許功能不會正常使用，例如隨機順序搜尋的的內容順序永遠不會改變，而登入卻還是會有搜尋頁數限制，無法瀏覽超過 20 頁的內容。

因為以上特性，我先是使用 cron 去做排程，讓我每 3 分鐘執行一次爬蟲的程式去迴避掉流量限制的問題，而在爬蟲過程中我先登入帳號，然後使用的隨機順序搜尋來分批抓取資料以突破只能瀏覽 20 頁的限制。

### 爬蟲架構
我使用 scrapy 作為爬蟲的架構，因為它可以快速的去抓取資料且做資料的前處理，以下是 scrapy 的架構：

![](https://i.imgur.com/APHP232.png)

我有做額外修改的部份有 spider, item, pipeline ：
- spider
    1. 送出登入的 Form request 後保存回傳的 session id 。
    2. 送出想詢問的標籤內容後獲得網站回傳的內容。
    3. 從網站內容抓取出每張圖片有的標籤、種類與 id 且解析圖片 url 存入 item 。
- item
    1. 儲存每張圖片的不同資料。
    2. 輸出標籤、種類與 id 。
    3. 輸出圖片
- pipeline
    1. 在 item 的部份由 url 請求該圖片的資料。
    2. 在圖片的部份去確認大小，如果小於所需大小則丟棄。

## Preprocessing 
- 標籤： \
在標籤的部份會出現圖片中角色的名字與出處、繪師的資料與圖片其他的基本資訊（例如：圖片大小），還會因為隨機抓取資料導致資料重複，因此我先經過第一次處理，將重複的資料與大部分不需要的標籤去做捨棄後依照屬性分開存取，第二次處理則是將標籤中出現性別與性格的標籤去做去除（例如：tomboy, trap, female, male），然後取出出現次數大於某界線（出現在其中一種屬性超過 150 次）的標籤做選擇的 feature 後做 one-hot encode，最後資料為各個屬性各 4500 筆資料，且每筆資料會有 ~250 個 feature。

- 圖片： \
圖片因為許多大小都不一樣，第一次處理中我先使用 imageMagick 將圖片用 resize and padding 的方式統一轉成 128x128 px 的大小後儲存，第二次處理則是依據屬性分別處存到不同的資料夾方便測試。

## Data Visualization & Data analysis
去除掉性別與個性的標籤後，我們可以觀察到幾點現象：
- 雖然去掉性別，但許多時候能以其他性徵去做判斷圖中角色的性別。
- 不同的個性對於外觀的有不錯的影響。
- boy 平均每張圖片的標籤數量少，累計使用的標籤數量也都很少。
![](https://i.imgur.com/RWF3xw3.png)
![](https://i.imgur.com/doPEoNe.png)
![](https://i.imgur.com/6YcUlzN.png)
![](https://i.imgur.com/rOPf6VW.png)


## Models
以下是我挑選的 Model 與挑選的原因：
- Random Forest \
因為資料都是以標籤的方式做，由最上圖中我們可以發現如果能找到對應的性別與有關個性的資料，就能容易的分類出來最後的屬性，而 Random Forest 能很好的用不同標籤的有無去做資料分類。

- Naive Bayes
不同的標籤在不同的屬性上出現的次數不同，因此這問題應該能用不同標籤出現在各個屬性的機率上去做最後屬性的判斷。

- Support Vector Mechine \
將標籤有無出現當作 0, 1 去做計算，那麼我們應該可以用 SVM 去選出分割的方式來去決定該圖片的屬性。

- Logistic Regression \
將標籤有無出現當作 0, 1 去做計算，那麼我們也應該可以用 Logistic Regression 去選出分割的方式來去決定該圖片的屬性。

- ANN \
用類神經網路去讓它判斷不同屬性與標籤的關聯後作決策。

- ~~CNN~~ \
用圖片的部份去做一些輔助的判斷，例如判斷性別或是性格後搭配上述模型使用。但是在實驗後發現效果不好，可能因為圖片畫風、形狀差距很大，角色種類過多等等因素，導致成功率跟猜的差不多，就算簡化問題變成判斷男女或是判斷個性也沒有變比較好，但值得一提的是判斷個性（boyish, girlish）的 accuracy 比判斷性別(boy, girl)的答對率高，由此可見個性所影響的外觀在視覺上是比性別（例如 trap）還好發現的。
![](https://i.imgur.com/uYpzMTU.png)


## Results
![](https://i.imgur.com/yLrPzCZ.png)
![](https://i.imgur.com/fYNlZIN.png)
![](https://i.imgur.com/rDH2emG.png)
![](https://i.imgur.com/5R3ZgCf.png)
![](https://i.imgur.com/OMFPhF7.png)



我從這些結果中得出以下結論：
我們可以看到 f1 score 與 accuracy 成績相似，也代表著每個不同屬性的答對率沒有非常顯著的差異。
- Random Forest \
成效很好，在這種判斷標籤的問題中能很好的解決問題，但很慢。
- Naive Bays \
非常的快，但在 boy 這種屬性中，相比於其他屬性，更容易因為標籤數量少且佔比少導致容易被歸類到其他屬性。
- SVM \
比較慢，但整體的答對率也不差。
- Logistic Regression \
非常的快，而且成效跟 SVM 一樣好。
- ANN \
成效雖然也很好，但速度最慢。

我在做實驗的時候有嘗試放寬選擇 feature 的標準，但除了計算時間變長以外，基本上答對率只在 Random Forest 與 ANN 上高了 0.5% ，在其他 model 還會因此降低答對率，我也有嘗試在不同 Model 上做 GridSearchCV 尋找最佳參數，但並沒有顯著增進準確率，因此最後都沒調整使用特定參數。

## Conclusion
### 判斷分析
在判斷屬性的部份，我們可以用 Decision Tree 去窺探一下判斷條件，我拿了我有的一張圖然後嘗試自己標示標籤後去做測試：

![](https://i.imgur.com/UxeC3iS.png)

```python=
X = ['dark_skin', 'short_hair', 'sportswear', 'breasts']
y = 'tomboy'
```

![](https://i.imgur.com/bbenF95.png)

如同假設的樣子，它會判斷性徵（有無鬍子、有無胸部等等）與外觀（長短髮，有無異裝）來去做最早的分類，之後再針對不同的標籤去做更深入的分類，測試的資料答案是 tomboy ，符合我所預期的答案。

### 錯誤分析

而我認為分辨錯的原因在於許多的圖片所標示有用的標籤不多，導致經過 one-hot encode 以後容易被辨別到其他屬性，就算去放寬選擇的 feature 也無法去讓機器找出正確答案。這也是為什麼擁有相近正確率或是類似判斷條件的 model 所呈現的 confusion matrix 也會極度相似的原因，因為不同的分類方法所遇到的瓶頸問題都相同。

原先我沒去除 females, male 時，答對率接近 90% ，且對於 boy 的分類也很成功（boy 基本上都有標示 male_focus， trap 不會），但是像是去除掉這些和其他與答案過於相關的標籤(reverse_trap, otoko_no_ko)後會因喪失許多明顯的資訊導致準確度下降。

### 總結與應用

而實驗結果表明我們的確能以其他描述實體的標籤，去推斷出一張圖片抽象一些的屬性，這不只能用在分類角色屬性上，也能拿來去分辨藝術品的風格，例如依照藝術品的上色色系、出現的物件去判斷該藝術品是屬於哪種門派的作品（例如寫實主義中常出現水果或農工），這些應用能夠讓我們更加容易找到與喜愛作品類似風格的其他作品。
